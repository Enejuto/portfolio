document.addEventListener("DOMContentLoaded", () => {
    const tutorial = document.getElementById("page-tutorial");
    const titleBox = document.querySelector(".tutorial-title");
    const textBox = document.querySelector(".tutorial-text");
    const continueBtn = document.querySelector(".tutorial-continue");
    const highlight = document.querySelector(".tutorial-highlight");
    const stepCounter = document.querySelector(".tutorial-step");
    const dimLayer = document.querySelector(".tutorial-dim");

    let step = 0;
    let currentSelector = null;
    let isScrollingTo = false;

    // Tutorial steps
    const steps = [
        {
            element: null,
            title: "Welcome!",
            text: "This is a short how-to on navigation within my portfolio. Click 'Continue' to proceed!"
        },
        {
            element: ".gallery-grid",
            title: "Showcased Works",
            text: "Here are my personally preferred projects and artworks that I have created over time and wish to display."
        },
        {
            element: ".aboutme-section",
            title: "Get to know me",
            text: "This section has a short summary of myself and my background"
        }
    ];

    /* -------------------------
       Cross-browser smooth scroll
       ------------------------- */
    function smoothScrollToY(y) {
        const supportsNativeSmooth = 'scrollBehavior' in document.documentElement.style;

        if (supportsNativeSmooth) {
            window.scroll({
                top: Math.max(0, Math.round(y)),
                behavior: 'smooth'
            });
        } else {
            // fallback
            window.scrollTo(0, Math.max(0, Math.round(y)));
        }
    }

    function smoothScrollToElement(el, offset = 200) {
        if (!el) return;
        const rect = el.getBoundingClientRect();
        const y = rect.top + window.scrollY - offset;

        // prefer scroll() where available, fallback to scrollIntoView
        if ('scrollBehavior' in document.documentElement.style) {
            window.scroll({ top: Math.max(0, Math.round(y)), behavior: 'smooth' });
        } else if (el.scrollIntoView) {
            try {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) {
                el.scrollIntoView(); // ancient fallback
            }
        } else {
            window.scrollTo(0, Math.max(0, Math.round(y)));
        }
    }

    /* -------------------------
       Update highlight position (runs on scroll/resize)
       highlight is position: fixed so we use getBoundingClientRect
       ------------------------- */
    function updateHighlightPosition() {
        if (!currentSelector) {
            highlight.style.opacity = '0';
            return;
        }

        const el = document.querySelector(currentSelector);
        if (!el) {
            highlight.style.opacity = '0';
            return;
        }

        const rect = el.getBoundingClientRect();

        // Position highlight using viewport coords
        highlight.style.left = rect.left + "px";
        highlight.style.top = rect.top + "px";
        highlight.style.width = rect.width + "px";
        highlight.style.height = rect.height + "px";
        highlight.style.opacity = '1';
    }

    /* -------------------------
       Set highlight for a selector and ensure element visible
       ------------------------- */
    function setHighlightFor(selector) {
        currentSelector = selector;

        if (!selector) {
            highlight.style.opacity = '0';
            return;
        }

        const el = document.querySelector(selector);
        if (!el) {
            highlight.style.opacity = '0';
            return;
        }

        // First try to scroll element into view before placing highlight
        isScrollingTo = true;
        smoothScrollToElement(el, 180);

        // After a short delay (allows smooth scroll start), update highlight position,
        // then rely on scroll event to keep it synced.
        // Using setTimeout is simple and robust across browsers
        setTimeout(() => {
            updateHighlightPosition();
            isScrollingTo = false;
        }, 300);
    }

    /* -------------------------
       load step
       ------------------------- */
    function loadStep(n) {
        if (n >= steps.length) {
            // hide
            tutorial.classList.add("tutorial-hidden");
            dimLayer.style.opacity = "0";
            highlight.style.opacity = "0";
            currentSelector = null;
            return;
        }

        const s = steps[n];

        titleBox.textContent = s.title;
        textBox.textContent = s.text;
        stepCounter.textContent = `STEP ${n + 1} OF ${steps.length}`;

        // show and dim
        tutorial.classList.remove("tutorial-hidden");
        dimLayer.style.opacity = "1";

        // configure highlight (may be null)
        setHighlightFor(s.element);
    }

    continueBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        step++;
        loadStep(step);
    });

    // Recompute highlight each time we scroll/resize so highlight tracks element
    window.addEventListener("scroll", () => {
        // don't spam computations while we are initiating scroll; still update
        updateHighlightPosition();
    }, { passive: true });

    window.addEventListener("resize", () => {
        updateHighlightPosition();
    });

    // Public start function
    window.startTutorial = () => {
        step = 0;
        loadStep(0);
    };

    // If tutorial is visible on load, ensure highlight positioned
    // (useful if you auto-start)
    setTimeout(() => {
        if (!tutorial.classList.contains("tutorial-hidden")) {
            updateHighlightPosition();
        }
    }, 350);
});
